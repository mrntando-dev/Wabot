const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
require('dotenv').config();

// Configuration
const PREFIX = process.env.PREFIX || '!';
const OWNER_NUMBER = process.env.OWNER_NUMBER || '1234567890'; // Format: country code + number (no + or spaces)
const OWNER_NAME = process.env.OWNER_NAME || 'Bot Owner';

// Initialize WhatsApp client
const client = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: {
        headless: true,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--no-first-run',
            '--no-zygote',
            '--single-process',
            '--disable-gpu'
        ]
    }
});

// Generate QR code for authentication
client.on('qr', (qr) => {
    console.log('QR Code received! Scan it with WhatsApp:');
    qrcode.generate(qr, { small: true });
});

// Client ready
client.on('ready', () => {
    console.log('âœ… WhatsApp Bot is ready!');
    console.log(`ğŸ“± Prefix: ${PREFIX}`);
    console.log(`ğŸ‘¤ Owner: ${OWNER_NAME}`);
});

// Handle authentication
client.on('authenticated', () => {
    console.log('âœ… Authenticated successfully!');
});

client.on('auth_failure', (msg) => {
    console.error('âŒ Authentication failed:', msg);
});

// Handle messages
client.on('message', async (message) => {
    const body = message.body.trim();
    
    // Check if message starts with prefix
    if (!body.startsWith(PREFIX)) return;
    
    const args = body.slice(PREFIX.length).trim().split(/ +/);
    const command = args.shift().toLowerCase();
    
    try {
        switch (command) {
            case 'ping':
                await handlePing(message);
                break;
            
            case 'alive':
                await handleAlive(message);
                break;
            
            case 'owner':
                await handleOwner(message);
                break;
            
            default:
                // Optional: respond to unknown commands
                // await message.reply('Unknown command. Try: ping, alive, owner');
                break;
        }
    } catch (error) {
        console.error('Error handling command:', error);
        await message.reply('An error occurred while processing your command.');
    }
});

// Command handlers
async function handlePing(message) {
    const start = Date.now();
    const sent = await message.reply('Pinging...');
    const latency = Date.now() - start;
    
    await sent.edit(`ğŸ“ *Pong!*\nâ±ï¸ Latency: ${latency}ms`);
}

async function handleAlive(message) {
    const uptime = process.uptime();
    const hours = Math.floor(uptime / 3600);
    const minutes = Math.floor((uptime % 3600) / 60);
    const seconds = Math.floor(uptime % 60);
    
    const aliveMessage = `
âœ… *Bot is Alive!*

â° *Uptime:* ${hours}h ${minutes}m ${seconds}s
ğŸ¤– *Status:* Running
ğŸ“± *Platform:* WhatsApp Web
ğŸ”§ *Version:* 1.0.0
    `.trim();
    
    await message.reply(aliveMessage);
}

async function handleOwner(message) {
    const ownerMessage = `
ğŸ‘¤ *Bot Owner Information*

ğŸ“› *Name:* ${OWNER_NAME}
ğŸ“ *Number:* +${OWNER_NUMBER}
ğŸ”— *Contact:* wa.me/${OWNER_NUMBER}

_Thank you for using this bot!_
    `.trim();
    
    await message.reply(ownerMessage);
}

// Error handling
client.on('disconnected', (reason) => {
    console.log('âŒ Client was disconnected:', reason);
});

process.on('SIGINT', async () => {
    console.log('Shutting down gracefully...');
    await client.destroy();
    process.exit(0);
});

// Initialize client
client.initialize();

// Keep alive for Render.com (optional - prevents sleeping)
const PORT = process.env.PORT || 3000;
const http = require('http');

http.createServer((req, res) => {
    res.writeHead(200, { 'Content-Type': 'text/plain' });
    res.end('WhatsApp Bot is running!\n');
}).listen(PORT, () => {
    console.log(`ğŸŒ Health check server running on port ${PORT}`);
});
